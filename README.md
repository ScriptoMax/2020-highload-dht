# Мониторинг работы сервера с поддержкой асинхронных операций (<em>wrk</em> + <em>async-profiler</em>)

**Система и программные средства** 
| | |
|-|-|
| ОС | Ubuntu Linux 18.04 LTS x64-bit |
| ЦПУ | Intel(R) Celeron(R) N4000 CPU @ 1.10GHz |
| Объём RAM | 8 ГБ |
| Количество ядер ЦПУ | 2 |
| [wrk2](https://github.com/giltene/wrk2) | v. 4.0.0 |
| [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) | 1.8.1 |
| [VisualVM](https://visualvm.github.io/) | 2.0.4 |

В исследовании производительности, предпринятом на отчётном этапе, рассмотрены показатели работы HTTP-сервера в различных программных конфигурациях RocksDB: базовой и расширенной, включающей ряд опций с потенциальным улучшением параллелизма.<br/> 
Нагрузочные испытания, проведённые с использованием <em>wrk</em>, организованы в виде серий PUT- и GET-запросов (длительность каждой - 7 минут) в условиях симулирования обмена данными с множеством клиентов (число клиентов установлено равным 16, количество параллельных потоков - 2 по числу ядер ЦПУ). Интенсивность генерации / отправки запросов каждого вида задана равной 15000 запросов/с.

**Команды <em>wrk</em>**<br/>
<ins><em>wrk</em> | PUT</ins>
```
wrk -t2 -c64 -d7m -s src/profiling/wrk_scripts/put.lua -R15000 --latency http://127.0.0.1:8080
```

<ins><em>wrk</em> | GET</ins>
```
wrk -t2 -c64 -d7m -s src/profiling/wrk_scripts/get.lua -R15000 --latency http://127.0.0.1:8080
```

**Команды <em>async-profiler</em>**<br/>
<ins><em>async-profiler</em> | cpu</ins>
```
./profiler.sh -d 60 -e cpu -t -f /path/to/output/folder/flame_output_cpu.svg --title "Async server CPU" <server_process_pid>
```

<ins><em>async-profiler</em> | alloc</ins>
```
./profiler.sh -d 60 -e alloc -t -f /path/to/output/folder/flame_output_alloc.svg --title "Async server RAM" <server_process_pid>
```

<ins><em>async-profiler</em> | cpu</ins>
```
./profiler.sh -d 60 -e lock -t -f /path/to/output/folder/flame_output_lock.svg --title "Async server lock/monitor" <server_pid>
```

Результаты мониторинга для различных конфигураций хранилища приведены далее.  
### 1. Добавление/изменение записей (PUT)

<ins>Вывод <em>wrk</em></ins>  
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/put.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 790.951ms, rate sampling interval: 2873ms
  Thread calibration: mean lat.: 1001.253ms, rate sampling interval: 3397ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   714.19ms    1.51s    6.77s    87.56%
    Req/Sec     7.52k   580.97     9.73k    76.34%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   14.64ms
 75.000%  422.14ms
 90.000%    3.35s 
 99.000%    6.13s 
 99.900%    6.52s 
 99.990%    6.71s 
 99.999%    6.77s 
100.000%    6.77s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.089     0.000000            1         1.00
       0.958     0.100000       617435         1.11
       1.486     0.200000      1234068         1.25
       2.261     0.300000      1850251         1.43
       5.203     0.400000      2466580         1.67
      14.639     0.500000      3083111         2.00
      33.471     0.550000      3391517         2.22
      71.231     0.600000      3699917         2.50
     129.599     0.650000      4008045         2.86
     238.719     0.700000      4316345         3.33
     422.143     0.750000      4624455         4.00
     577.023     0.775000      4778688         4.44
     756.735     0.800000      4932989         5.00
     936.447     0.825000      5087215         5.71
    1311.743     0.850000      5241116         6.67
    2166.783     0.875000      5395257         8.00
    3090.431     0.887500      5472365         8.89
    3350.527     0.900000      5549598        10.00
    3864.575     0.912500      5626772        11.43
    4231.167     0.925000      5703487        13.33
    4485.119     0.937500      5781386        16.00
    4689.919     0.943750      5819408        17.78
    4915.199     0.950000      5857658        20.00
    5042.175     0.956250      5897301        22.86
    5132.287     0.962500      5935118        26.67
    5246.975     0.968750      5973267        32.00
    5349.375     0.971875      5993466        35.56
    5431.295     0.975000      6012596        40.00
    5505.023     0.978125      6031736        45.71
    5578.751     0.981250      6050414        53.33
    5664.767     0.984375      6069850        64.00
    5746.687     0.985938      6079362        71.11
    5898.239     0.987500      6089011        80.00
    6062.079     0.989062      6098601        91.43
    6168.575     0.990625      6108412       106.67
    6234.111     0.992188      6118396       128.00
    6262.783     0.992969      6122720       142.22
    6291.455     0.993750      6127978       160.00
    6311.935     0.994531      6132733       182.86
    6332.415     0.995313      6137421       213.33
    6356.991     0.996094      6141901       256.00
    6373.375     0.996484      6144402       284.44
    6393.855     0.996875      6147004       320.00
    6410.239     0.997266      6149305       365.71
    6430.719     0.997656      6151862       426.67
    6455.295     0.998047      6154323       512.00
    6463.487     0.998242      6155137       568.89
    6479.871     0.998437      6156423       640.00
    6492.159     0.998633      6157544       731.43
    6508.543     0.998828      6158836       853.33
    6529.023     0.999023      6160057      1024.00
    6537.215     0.999121      6160724      1137.78
    6545.407     0.999219      6161237      1280.00
    6557.695     0.999316      6161889      1462.86
    6569.983     0.999414      6162420      1706.67
    6582.271     0.999512      6162920      2048.00
    6590.463     0.999561      6163341      2275.56
    6598.655     0.999609      6163576      2560.00
    6610.943     0.999658      6163881      2925.71
    6619.135     0.999707      6164173      3413.33
    6627.327     0.999756      6164460      4096.00
    6647.807     0.999780      6164594      4551.11
    6660.095     0.999805      6164765      5120.00
    6676.479     0.999829      6164896      5851.43
    6688.767     0.999854      6165084      6826.67
    6696.959     0.999878      6165212      8192.00
    6701.055     0.999890      6165290      9102.22
    6705.151     0.999902      6165355     10240.00
    6713.343     0.999915      6165426     11702.86
    6721.535     0.999927      6165498     13653.33
    6733.823     0.999939      6165590     16384.00
    6737.919     0.999945      6165656     18204.44
    6737.919     0.999951      6165656     20480.00
    6742.015     0.999957      6165680     23405.71
    6746.111     0.999963      6165715     27306.67
    6750.207     0.999969      6165751     32768.00
    6754.303     0.999973      6165788     36408.89
    6754.303     0.999976      6165788     40960.00
    6758.399     0.999979      6165812     46811.43
    6762.495     0.999982      6165839     54613.33
    6762.495     0.999985      6165839     65536.00
    6766.591     0.999986      6165899     72817.78
    6766.591     0.999988      6165899     81920.00
    6766.591     0.999989      6165899     93622.86
    6766.591     0.999991      6165899    109226.67
    6766.591     0.999992      6165899    131072.00
    6766.591     0.999993      6165899    145635.56
    6766.591     0.999994      6165899    163840.00
    6766.591     0.999995      6165899    187245.71
    6770.687     0.999995      6165925    218453.33
    6770.687     0.999996      6165925    262144.00
    6770.687     0.999997      6165925    291271.11
    6770.687     0.999997      6165925    327680.00
    6770.687     0.999997      6165925    374491.43
    6770.687     0.999998      6165925    436906.67
    6770.687     0.999998      6165925    524288.00
    6770.687     0.999998      6165925    582542.22
    6770.687     0.999998      6165925    655360.00
    6770.687     0.999999      6165925    748982.86
    6770.687     0.999999      6165925    873813.33
    6770.687     0.999999      6165925   1048576.00
    6770.687     0.999999      6165925   1165084.44
    6774.783     0.999999      6165930   1310720.00
    6774.783     1.000000      6165930          inf
#[Mean    =      714.190, StdDeviation   =     1512.034]
#[Max     =     6770.688, Total count    =      6165930]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  6293974 requests in 7.00m, 402.16MB read
Requests/sec:  14985.67
Transfer/sec:      0.96MB
```
В соответствии с приведённым выводом средняя задержка при обработке запросов на добавление записей достигла 700 мс при отклонении на уровне 87%. Каждую секунду сервер выполнял свыше 7500 запросов, в то время как интенсивность их подачи оказалась близкой целевому значению (15000 запросов/с). В структуре квантильного распределения времён отклика максимальная длительность ответа установлена равной 6.77 с, получение отклика на 90% запросов уложилось в 6.5 с.<br/>            
<ins>Flamegraph-анализ</ins><br/>  

![put_cpu_64](https://user-images.githubusercontent.com/55311053/95678810-a8a21200-0bd7-11eb-848f-4acf15daaf6f.jpg)
<p align="center">Рис.1. Выделение ресурса CPU при симулировании PUT-запросов (async-featured)</p>

![put_cpu_ext](https://user-images.githubusercontent.com/55311053/95623828-9791bd80-0a7e-11eb-984b-fd61321ec7f1.jpg)
<p align="center">Рис.2. Выделение ресурса CPU при симулировании PUT-запросов (threadsafe synchronized)</p>

![put_alloc_64](https://user-images.githubusercontent.com/55311053/95678826-b3f53d80-0bd7-11eb-8384-97e655673c35.jpg)
<p align="center">Рис.3. Выделение ресурса RAM при симулировании PUT-запросов (async-featured)</p>

![put_alloc_ext](https://user-images.githubusercontent.com/55311053/95623757-7b8e1c00-0a7e-11eb-8e04-d06a5f805681.jpg)
<p align="center">Рис.4. Выделение ресурса RAM при симулировании PUT-запросов (threadsafe synchronized)</p>

![put_lock_64](https://user-images.githubusercontent.com/55311053/95678890-19e1c500-0bd8-11eb-976f-0818a87e6c88.jpg)
<p align="center">Рис.5. Профиль lock/monitor при симулировании PUT-запросов (async-featured)</p>

Визуализация нагрузки на процессор позволяет сделать вывод о доминировании в общей структуре операций, связанных с выполнением ThreadPoolExecutor. Значительную долю процессорного времени составили чтение, парсинг данных из буфера вкупе с формированием и отправкой результирующих данных. Влияние многопоточности прослеживается и на графе выделения памяти. На нём же следует отметить активное аллоцирование RAM при вызове метода асинхронной обработки запросов (<em>pushAsyncRun</em>). <br/>               

### 2. Чтение записей (GET)

<ins>Вывод <em>wrk</em></ins>
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/get.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 340.227ms, rate sampling interval: 1201ms
  Thread calibration: mean lat.: 312.922ms, rate sampling interval: 1144ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    18.22ms   89.35ms 890.88ms   96.48%
    Req/Sec     3.28k     1.39k    7.67k    39.91%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.93ms
 75.000%    1.54ms
 90.000%    8.33ms
 99.000%  576.00ms
 99.900%  811.01ms
 99.990%  867.33ms
 99.999%  887.29ms
100.000%  891.39ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       0.369     0.100000       266844         1.11
       0.532     0.200000       535135         1.25
       0.649     0.300000       800205         1.43
       0.794     0.400000      1066954         1.67
       0.934     0.500000      1333375         2.00
       1.020     0.550000      1466817         2.22
       1.115     0.600000      1600524         2.50
       1.202     0.650000      1733114         2.86
       1.333     0.700000      1866740         3.33
       1.545     0.750000      1999752         4.00
       1.813     0.775000      2066335         4.44
       2.311     0.800000      2133026         5.00
       3.085     0.825000      2199667         5.71
       4.271     0.850000      2266432         6.67
       5.879     0.875000      2332939         8.00
       6.883     0.887500      2366235         8.89
       8.327     0.900000      2399634        10.00
      10.479     0.912500      2432987        11.43
      13.983     0.925000      2466271        13.33
      20.767     0.937500      2499551        16.00
      27.007     0.943750      2516222        17.78
      38.207     0.950000      2532907        20.00
      57.727     0.956250      2549543        22.86
      88.575     0.962500      2566208        26.67
     153.983     0.968750      2582871        32.00
     200.319     0.971875      2591207        35.56
     290.815     0.975000      2599547        40.00
     359.423     0.978125      2607888        45.71
     403.967     0.981250      2616223        53.33
     455.423     0.984375      2624527        64.00
     473.855     0.985938      2628688        71.11
     496.127     0.987500      2632861        80.00
     535.039     0.989062      2637041        91.43
     613.375     0.990625      2641198       106.67
     663.551     0.992188      2645390       128.00
     679.935     0.992969      2647452       142.22
     691.199     0.993750      2649531       160.00
     699.903     0.994531      2651660       182.86
     707.583     0.995313      2653703       213.33
     719.359     0.996094      2655792       256.00
     724.479     0.996484      2656850       284.44
     729.599     0.996875      2657879       320.00
     735.231     0.997266      2658945       365.71
     749.055     0.997656      2659954       426.67
     775.679     0.998047      2660980       512.00
     784.383     0.998242      2661500       568.89
     789.503     0.998437      2662040       640.00
     795.135     0.998633      2662544       731.43
     803.327     0.998828      2663069       853.33
     812.031     0.999023      2663619      1024.00
     815.615     0.999121      2663844      1137.78
     820.735     0.999219      2664110      1280.00
     826.367     0.999316      2664356      1462.86
     833.535     0.999414      2664642      1706.67
     838.655     0.999512      2664888      2048.00
     841.215     0.999561      2665020      2275.56
     844.799     0.999609      2665152      2560.00
     847.871     0.999658      2665275      2925.71
     850.431     0.999707      2665417      3413.33
     852.479     0.999756      2665534      4096.00
     854.527     0.999780      2665607      4551.11
     856.575     0.999805      2665660      5120.00
     859.647     0.999829      2665726      5851.43
     862.207     0.999854      2665793      6826.67
     864.767     0.999878      2665854      8192.00
     866.303     0.999890      2665894      9102.22
     867.839     0.999902      2665921     10240.00
     870.399     0.999915      2665956     11702.86
     872.959     0.999927      2665987     13653.33
     875.519     0.999939      2666022     16384.00
     876.031     0.999945      2666037     18204.44
     876.543     0.999951      2666048     20480.00
     877.567     0.999957      2666065     23405.71
     879.103     0.999963      2666083     27306.67
     880.639     0.999969      2666099     32768.00
     881.663     0.999973      2666106     36408.89
     883.711     0.999976      2666114     40960.00
     885.247     0.999979      2666123     46811.43
     885.759     0.999982      2666131     54613.33
     886.271     0.999985      2666141     65536.00
     886.783     0.999986      2666150     72817.78
     886.783     0.999988      2666150     81920.00
     886.783     0.999989      2666150     93622.86
     887.295     0.999991      2666157    109226.67
     887.807     0.999992      2666164    131072.00
     887.807     0.999993      2666164    145635.56
     887.807     0.999994      2666164    163840.00
     887.807     0.999995      2666164    187245.71
     888.319     0.999995      2666170    218453.33
     888.319     0.999996      2666170    262144.00
     888.319     0.999997      2666170    291271.11
     888.319     0.999997      2666170    327680.00
     888.831     0.999997      2666172    374491.43
     888.831     0.999998      2666172    436906.67
     889.343     0.999998      2666173    524288.00
     889.855     0.999998      2666175    582542.22
     889.855     0.999998      2666175    655360.00
     889.855     0.999999      2666175    748982.86
     889.855     0.999999      2666175    873813.33
     890.367     0.999999      2666176   1048576.00
     890.367     0.999999      2666176   1165084.44
     890.367     0.999999      2666176   1310720.00
     890.879     0.999999      2666177   1497965.71
     890.879     0.999999      2666177   1747626.67
     890.879     1.000000      2666177   2097152.00
     890.879     1.000000      2666177   2330168.89
     890.879     1.000000      2666177   2621440.00
     891.391     1.000000      2666178   2995931.43
     891.391     1.000000      2666178          inf
#[Mean    =       18.218, StdDeviation   =       89.349]
#[Max     =      890.880, Total count    =      2666178]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2816509 requests in 7.00m, 183.21MB read
  Socket errors: connect 0, read 0, write 0, timeout 1841
Requests/sec:   6705.91
Transfer/sec:    446.68KB

```
Приведённые результаты отражают существенное снижение времени отклика в сравнении с оценками, актуальными для операций добавления. При средней задержке в 18 мс (отклонение на уровне 96%) сервер получал в обработку более 3200 запросов в каждую единицу времени. В 99% случаев время ожидания отклика не превысило 600 мс, худший результат оказался в пределах 1 с.<br/>                  

<ins>Flamegraph-анализ</ins><br/>  

![get_cpu_64](https://user-images.githubusercontent.com/55311053/95678755-5b25a500-0bd7-11eb-8f85-5e19bfc3a506.jpg)
<p align="center">Рис.6. Выделение ресурса CPU при симулировании GET-запросов (async-featured)</p>

![get_cpu_ext](https://user-images.githubusercontent.com/55311053/95623668-60231100-0a7e-11eb-97c3-76c8c4280630.jpg)
<p align="center">Рис.7. Выделение ресурса CPU при симулировании GET-запросов (threadsafe synchronized)</p>

![get_alloc_64](https://user-images.githubusercontent.com/55311053/95678769-709acf00-0bd7-11eb-89bb-3cdb83b78cf6.jpg)
<p align="center">Рис.8. Выделение ресурса RAM при симулировании GET-запросов (async-featured)</p>

![get_alloc_ext](https://user-images.githubusercontent.com/55311053/95623573-2fdb7280-0a7e-11eb-99b8-fad5d51d8f5f.jpg)
<p align="center">Рис.9. Выделение ресурса RAM при симулировании GET-запросов (threadsafe synchronized)</p>

![get_lock_64](https://user-images.githubusercontent.com/55311053/95678783-83ad9f00-0bd7-11eb-84a0-2b8aa5bd8314.jpg)
<p align="center">Рис.10. Профиль lock/monitor при симулировании GET-запросов (async-featured)</p>

Представленные графы в значительной мере воспроизводят профили, полученные для серии с операциями добавления. Как и в случае с последними, в структуре использования процессорного времени превалируют операции с ThreadPoolExecutor, буфером данных и сокетом. Дополнительную нагрузку на ресурс RAM создают операции преобразования типов данных между байтовыми и строковыми объектами.
