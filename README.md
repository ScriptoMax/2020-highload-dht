# Мониторинг работы сервера с поддержкой параллельных соединений (<em>wrk</em> + <em>async-profiler</em>)

**Система и программные средства** 
| | |
|-|-|
| ОС | Ubuntu Linux 18.04 LTS 64-bit |
| ЦПУ | Intel(R) Celeron(R) N4000 CPU @ 1.10GHz |
| Объём RAM | 8 ГБ |
| Количество ядер ЦПУ | 2 |
| [wrk](https://github.com/giltene/wrk2) | v. 4.0.0 |
| [async-profiler](https://github.com/jvm-profiling-tools/async-profiler) | 1.8.1 |
| [VisualVM](https://visualvm.github.io/) | 2.0.4 |

В исследовании производительности, предпринятом на отчётном этапе, рассмотрены показатели работы highload-сервера в различных конфигурациях хранилища данных: базовой (далее - БКХ) и расширенной (РКХ), включающей ряд опций с ожидаемым уменьшением времени отклика за счёт оптимизации параллелизма.<br/> 
Нагрузочные испытания, проведённые с использованием <em>wrk</em>, организованы путём интенсивной генерации PUT- и GET-запросов (длительность каждой - 7 минут) в условиях симулирования обмена данными с множеством клиентов (число клиентов установлено равным 16, количество параллельных потоков - 2 по числу ядер ЦПУ). Интенсивность генерации / отправки запросов каждого вида задана равной 15000 запросов/с (значение выбрано исходя из предварительных оценок интенсивности генерации запросов (<em>Requests/sec</em>) через <em>wrk</em> в сравнении с ориентиром (<em>Rate</em>)).

**Команды <em>wrk</em>**

<p></p>

<ins><em>wrk</em> | PUT</ins>
```
wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/put.lua -R15000 --latency http://127.0.0.1:8080
```

<ins><em>wrk</em> | GET</ins>
```
wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/get.lua -R15000 --latency http://127.0.0.1:8080
```

**Команды <em>async-profiler</em>**<br/>

<p></p>

<ins><em>async-profiler</em> | cpu</ins>
```
./profiler.sh -d 60 -e cpu -t -f /path/to/output/folder/flame_output_cpu.svg <server_process_pid>
```

<ins><em>async-profiler</em> | alloc</ins>
```
./profiler.sh -d 60 -e alloc -t -f /path/to/output/folder/flame_output_alloc.svg <server_process_pid>
```

<ins><em>async-profiler</em> | cpu</ins>
```
./profiler.sh -d 60 -e lock -t -f /path/to/output/folder/flame_output_lock.svg <server_pid>
```
Результаты мониторинга для различных конфигураций хранилища приведены далее.  

## 1. RocksDB - базовая конфигурация (без оптимизации параллелизма)

<ins>Код в TaskDAO.java</ins>
```
public TaskDAO(@NotNull final File data) throws IOException {
            final Options opts = new Options();
            opts.setCreateIfMissing(true); // create db instance if one does not exist
            opts.setParanoidChecks(false); // drops strict data quality control while performing search for corrupt / erroneous elements
            opts.setSkipStatsUpdateOnDbOpen(true); // declines statistics updates every time db is opening to run           

            dbLocalDir = data;
            try {
                Files.createDirectories(dbLocalDir.getParentFile().toPath());
                Files.createDirectories(dbLocalDir.getAbsoluteFile().toPath());
                db = RocksDB.open(opts, dbLocalDir.getAbsolutePath());
            } catch (IOException | RocksDBException exc) {
                logger.log(Level.SEVERE, "Storage initialization failed", exc);
            }
        }
```

### 1.1. PUT

<ins>Вывод <em>wrk</em></ins>  
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/put.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 83.992ms, rate sampling interval: 632ms
  Thread calibration: mean lat.: 43.036ms, rate sampling interval: 374ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.50ms   12.46ms 394.50ms   98.90%
    Req/Sec     7.51k   106.96    10.03k    95.30%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.34ms
 75.000%    1.92ms
 90.000%    2.64ms
 99.000%   18.03ms
 99.900%  230.53ms
 99.990%  349.18ms
 99.999%  388.35ms
100.000%  394.75ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.075     0.000000            1         1.00
       0.553     0.100000       616306         1.11
       0.778     0.200000      1230994         1.25
       0.971     0.300000      1846985         1.43
       1.154     0.400000      2460903         1.67
       1.341     0.500000      3076190         2.00
       1.441     0.550000      3385070         2.22
       1.545     0.600000      3689731         2.50
       1.659     0.650000      3998270         2.86
       1.783     0.700000      4305062         3.33
       1.924     0.750000      4613240         4.00
       2.002     0.775000      4767522         4.44
       2.089     0.800000      4922516         5.00
       2.185     0.825000      5074872         5.71
       2.299     0.850000      5228508         6.67
       2.443     0.875000      5382231         8.00
       2.531     0.887500      5458091         8.89
       2.639     0.900000      5534624        10.00
       2.777     0.912500      5611661        11.43
       2.965     0.925000      5688456        13.33
       3.251     0.937500      5765051        16.00
       3.485     0.943750      5803549        17.78
       3.853     0.950000      5841916        20.00
       4.447     0.956250      5880444        22.86
       5.279     0.962500      5918828        26.67
       6.219     0.968750      5957211        32.00
       6.711     0.971875      5976533        35.56
       7.243     0.975000      5995690        40.00
       7.879     0.978125      6014892        45.71
       8.735     0.981250      6034064        53.33
      10.007     0.984375      6053256        64.00
      10.943     0.985938      6062920        71.11
      12.335     0.987500      6072484        80.00
      15.175     0.989062      6082070        91.43
      20.303     0.990625      6091696       106.67
      27.087     0.992188      6101286       128.00
      30.959     0.992969      6106092       142.22
      36.575     0.993750      6110901       160.00
      45.567     0.994531      6115703       182.86
      57.023     0.995313      6120513       213.33
      74.367     0.996094      6125307       256.00
      86.655     0.996484      6127716       284.44
     100.415     0.996875      6130121       320.00
     111.231     0.997266      6132520       365.71
     127.167     0.997656      6134917       426.67
     157.567     0.998047      6137332       512.00
     165.887     0.998242      6138522       568.89
     178.175     0.998437      6139734       640.00
     193.407     0.998633      6140920       731.43
     215.679     0.998828      6142127       853.33
     232.447     0.999023      6143328      1024.00
     243.071     0.999121      6143926      1137.78
     258.303     0.999219      6144525      1280.00
     271.871     0.999316      6145129      1462.86
     282.111     0.999414      6145725      1706.67
     292.863     0.999512      6146327      2048.00
     301.823     0.999561      6146635      2275.56
     311.295     0.999609      6146932      2560.00
     319.999     0.999658      6147231      2925.71
     328.191     0.999707      6147534      3413.33
     334.847     0.999756      6147840      4096.00
     337.663     0.999780      6147983      4551.11
     339.455     0.999805      6148156      5120.00
     340.479     0.999829      6148291      5851.43
     343.295     0.999854      6148432      6826.67
     346.367     0.999878      6148585      8192.00
     348.671     0.999890      6148665      9102.22
     349.439     0.999902      6148734     10240.00
     351.487     0.999915      6148809     11702.86
     354.815     0.999927      6148877     13653.33
     358.655     0.999939      6148955     16384.00
     360.447     0.999945      6148990     18204.44
     362.239     0.999951      6149034     20480.00
     363.519     0.999957      6149066     23405.71
     365.055     0.999963      6149108     27306.67
     367.103     0.999969      6149140     32768.00
     369.407     0.999973      6149159     36408.89
     371.967     0.999976      6149178     40960.00
     374.527     0.999979      6149196     46811.43
     378.623     0.999982      6149216     54613.33
     381.951     0.999985      6149234     65536.00
     384.255     0.999986      6149243     72817.78
     386.559     0.999988      6149253     81920.00
     387.839     0.999989      6149262     93622.86
     388.863     0.999991      6149271    109226.67
     390.399     0.999992      6149282    131072.00
     390.911     0.999993      6149289    145635.56
     391.167     0.999994      6149293    163840.00
     391.423     0.999995      6149296    187245.71
     391.935     0.999995      6149303    218453.33
     392.191     0.999996      6149306    262144.00
     392.191     0.999997      6149306    291271.11
     392.703     0.999997      6149310    327680.00
     392.959     0.999997      6149311    374491.43
     393.215     0.999998      6149314    436906.67
     393.471     0.999998      6149317    524288.00
     393.471     0.999998      6149317    582542.22
     393.727     0.999998      6149320    655360.00
     393.727     0.999999      6149320    748982.86
     393.727     0.999999      6149320    873813.33
     393.983     0.999999      6149322   1048576.00
     393.983     0.999999      6149322   1165084.44
     394.239     0.999999      6149324   1310720.00
     394.239     0.999999      6149324   1497965.71
     394.239     0.999999      6149324   1747626.67
     394.495     1.000000      6149326   2097152.00
     394.495     1.000000      6149326   2330168.89
     394.495     1.000000      6149326   2621440.00
     394.495     1.000000      6149326   2995931.43
     394.495     1.000000      6149326   3495253.33
     394.495     1.000000      6149326   4194304.00
     394.495     1.000000      6149326   4660337.78
     394.495     1.000000      6149326   5242880.00
     394.495     1.000000      6149326   5991862.86
     394.751     1.000000      6149327   6990506.67
     394.751     1.000000      6149327          inf
#[Mean    =        2.502, StdDeviation   =       12.460]
#[Max     =      394.496, Total count    =      6149327]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  6299648 requests in 7.00m, 402.52MB read
Requests/sec:  14999.27
Transfer/sec:      0.96MB
```
Согласно результирующей сводке, средняя задержка при обработке запросов на добавление записей составила 2,5 мс при стандартном отклонении на уровне 98%. Каждую секунду в обработке находились более 7500 запросов, интенсивность их подачи совпала с целевым значением (15000 запросов/с). В статистике квантильного распределения максимальное ожидание ответа клиентом оказалось в пределах 400 мс. При этом получение отклика на 99,9% запросов заняло почти в 1,5 раза меньше времени, чем в случае с фиксацией худшей задержки.<br/>            
<ins>Flamegraph-анализ</ins><br/>  

![put_cpu_init](https://user-images.githubusercontent.com/55311053/95623826-96609080-0a7e-11eb-8567-52e2f753fbad.jpg)
<p align="center">Рис.1. Выделение процессорного времени при симулировании PUT-запросов (БКХ)</p>

![put_alloc_init](https://user-images.githubusercontent.com/55311053/95623752-7a5cef00-0a7e-11eb-8566-b2fa09da2d88.jpg)
<p align="center">Рис.2. Выделение RAM при симулировании PUT-запросов (БКХ)</p>

Визуализация профиля ЦПУ позволяет сделать вывод о доминировании в общей структуре операций чтения, парсинга данных из буфера наряду с формированием и отправкой результирующих данных через сокет. Аналогичные процессы выступают основными триггерами аллокаций.<br/>Ввиду того, что RocksDB обеспечивает потокобезопасность по умолчанию, код проекта не содержит специальных методов для управления совместным доступом. По этой причине профилирование <em>lock/monitor</em> лишено релевантных объектов и соответствующие графы (как в данном испытании, так и в последующих) оказываются пустыми.                        

### 1.2. GET

<ins>Вывод <em>wrk</em></ins>
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/get.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 10.636ms, rate sampling interval: 51ms
  Thread calibration: mean lat.: 11.790ms, rate sampling interval: 33ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.56ms    1.33ms  48.48ms   91.95%
    Req/Sec     7.60k   358.41    12.31k    87.40%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.34ms
 75.000%    1.90ms
 90.000%    2.52ms
 99.000%    7.28ms
 99.900%   13.39ms
 99.990%   29.65ms
 99.999%   44.22ms
100.000%   48.51ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.062     0.000000            1         1.00
       0.529     0.100000       615724         1.11
       0.759     0.200000      1230653         1.25
       0.960     0.300000      1846345         1.43
       1.148     0.400000      2460004         1.67
       1.340     0.500000      3077285         2.00
       1.439     0.550000      3383454         2.22
       1.543     0.600000      3691291         2.50
       1.653     0.650000      3999303         2.86
       1.772     0.700000      4306257         3.33
       1.905     0.750000      4613811         4.00
       1.978     0.775000      4767637         4.44
       2.057     0.800000      4920926         5.00
       2.145     0.825000      5073793         5.71
       2.247     0.850000      5228561         6.67
       2.369     0.875000      5382760         8.00
       2.439     0.887500      5457802         8.89
       2.521     0.900000      5535031        10.00
       2.619     0.912500      5611727        11.43
       2.741     0.925000      5688494        13.33
       2.905     0.937500      5765226        16.00
       3.013     0.943750      5804092        17.78
       3.145     0.950000      5842409        20.00
       3.321     0.956250      5880486        22.86
       3.575     0.962500      5918955        26.67
       3.975     0.968750      5957341        32.00
       4.271     0.971875      5976433        35.56
       4.659     0.975000      5995707        40.00
       5.135     0.978125      6014946        45.71
       5.663     0.981250      6034137        53.33
       6.215     0.984375      6053428        64.00
       6.495     0.985938      6063007        71.11
       6.783     0.987500      6072612        80.00
       7.087     0.989062      6082152        91.43
       7.415     0.990625      6091796       106.67
       7.795     0.992188      6101367       128.00
       8.011     0.992969      6106183       142.22
       8.255     0.993750      6111016       160.00
       8.543     0.994531      6115777       182.86
       8.879     0.995313      6120562       213.33
       9.303     0.996094      6125403       256.00
       9.551     0.996484      6127787       284.44
       9.847     0.996875      6130216       320.00
      10.183     0.997266      6132564       365.71
      10.591     0.997656      6134969       426.67
      11.087     0.998047      6137368       512.00
      11.399     0.998242      6138594       568.89
      11.783     0.998437      6139802       640.00
      12.247     0.998633      6140980       731.43
      12.767     0.998828      6142180       853.33
      13.495     0.999023      6143374      1024.00
      14.015     0.999121      6143974      1137.78
      14.663     0.999219      6144578      1280.00
      15.391     0.999316      6145174      1462.86
      16.431     0.999414      6145775      1706.67
      18.111     0.999512      6146377      2048.00
      18.991     0.999561      6146674      2275.56
      19.775     0.999609      6146974      2560.00
      20.639     0.999658      6147276      2925.71
      21.407     0.999707      6147575      3413.33
      22.271     0.999756      6147876      4096.00
      22.943     0.999780      6148028      4551.11
      23.823     0.999805      6148175      5120.00
      24.767     0.999829      6148329      5851.43
      26.095     0.999854      6148476      6826.67
      27.567     0.999878      6148627      8192.00
      28.575     0.999890      6148701      9102.22
      29.871     0.999902      6148776     10240.00
      30.687     0.999915      6148852     11702.86
      31.759     0.999927      6148926     13653.33
      32.687     0.999939      6149002     16384.00
      33.471     0.999945      6149039     18204.44
      34.655     0.999951      6149076     20480.00
      35.999     0.999957      6149114     23405.71
      37.855     0.999963      6149151     27306.67
      39.647     0.999969      6149189     32768.00
      40.383     0.999973      6149208     36408.89
      41.279     0.999976      6149227     40960.00
      41.919     0.999979      6149245     46811.43
      42.463     0.999982      6149264     54613.33
      43.071     0.999985      6149283     65536.00
      43.423     0.999986      6149292     72817.78
      43.679     0.999988      6149301     81920.00
      44.031     0.999989      6149311     93622.86
      44.351     0.999991      6149321    109226.67
      44.703     0.999992      6149330    131072.00
      44.895     0.999993      6149334    145635.56
      45.279     0.999994      6149339    163840.00
      45.471     0.999995      6149344    187245.71
      45.663     0.999995      6149348    218453.33
      46.047     0.999996      6149353    262144.00
      46.111     0.999997      6149356    291271.11
      46.399     0.999997      6149358    327680.00
      46.591     0.999997      6149360    374491.43
      46.847     0.999998      6149362    436906.67
      47.103     0.999998      6149365    524288.00
      47.167     0.999998      6149366    582542.22
      47.359     0.999998      6149367    655360.00
      47.455     0.999999      6149368    748982.86
      47.583     0.999999      6149369    873813.33
      47.743     0.999999      6149371   1048576.00
      47.743     0.999999      6149371   1165084.44
      47.775     0.999999      6149372   1310720.00
      47.775     0.999999      6149372   1497965.71
      47.839     0.999999      6149373   1747626.67
      47.871     1.000000      6149374   2097152.00
      47.871     1.000000      6149374   2330168.89
      47.871     1.000000      6149374   2621440.00
      47.871     1.000000      6149374   2995931.43
      48.031     1.000000      6149375   3495253.33
      48.031     1.000000      6149375   4194304.00
      48.031     1.000000      6149375   4660337.78
      48.031     1.000000      6149375   5242880.00
      48.031     1.000000      6149375   5991862.86
      48.511     1.000000      6149376   6990506.67
      48.511     1.000000      6149376          inf
#[Mean    =        1.563, StdDeviation   =        1.326]
#[Max     =       48.480, Total count    =      6149376]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  6299704 requests in 7.00m, 412.42MB read
Requests/sec:  14999.36
Transfer/sec:      0.98MB

```
Результаты данной серии отражают существенное снижение времени отклика в сравнении с оценками, полученными  для операций добавления. При средней задержке около 1,5 мс и отклонении 92% интенсивности обработки достигла 7600 запросов в секунду. В 99,9% случаев время ожидания отклика не превысило 14 мс, что приблизительно в 4 раза лучше максимального результата.<br/>                  

<ins>Flamegraph-анализ</ins><br/>  

![get_cpu_init](https://user-images.githubusercontent.com/55311053/95623646-57323f80-0a7e-11eb-800c-3121d9d5e4d5.jpg)

<p align="center">Рис.3. Выделение процессорного времени при симулировании GET-запросов (БКХ)</p>

![get_alloc_init](https://user-images.githubusercontent.com/55311053/95623570-2eaa4580-0a7e-11eb-9f94-9989463368e5.jpg)
<p align="center">Рис.4. Выделение RAM при симулировании GET-запросов (БКХ)</p>

Представленные графы в значительной мере воспроизводят профили, полученные для серии с операциями вставки. Как и в случае с последними, в структуре использования процессорного времени превалируют операции с буфером данных и сокетом. Дополнительную нагрузку на ресурс RAM создают операции преобразования типов данных между байтовыми и строковыми объектами.         

## 2. RocksDB - расширенная конфигурация (вариант оптимизации)

В качестве варианта улучшения реализации параллелизма в код конструктора экземпляра RocksDB были добавлены вызовы следующих методов класса Options:
| | |
|-|-|
| setMaxOpenFiles(-1)[4] | устранение ограничений на количество открытых файлов, доступных для обмена данными с БД в один и тот же момент времени |
| setAllowConcurrentMemtableWrite(true)[4] | разрешение параллельных операций записи в memtable |
| enableWriteThreadAdaptiveYield()[4] | установление предельной длительности записи в потоке, синхронизированном с <em>write batch group leader</em> (вплоть до момента блокировки мьютекса) |
| disableAutoCompactions()[4] | отключение автоматических уплотнений БД |
| setCompactionStyle(CompactionStyle.UNIVERSAL)[3][5] | выбор общего (universal) алгоритма уплотнения (в терминах RocksDB) |
| setCompactionOptionsUniversal[2] | изменение алгоритма сжатия данных (применение L4Z вместо SNAPPY по умолчанию) |

Справочные ресурсы:<br/>1. [github.com/facebook/rocksdb/wiki/](https://github.com/facebook/rocksdb/wiki)<br/>
2. [https://github.com/facebook/rocksdb/wiki/](https://github.com/facebook/rocksdb/wiki/Compression)<br/>
3. [github.com/tecbot/gorocksdb/](https://github.com/tecbot/gorocksdb/blob/master/options.go)<br/>
4. [javadoc.io](https://javadoc.io/doc/org.rocksdb/rocksdbjni/latest/index.html)<br/>
5. [zhangyuchi.gitbooks.io/rocksdbbook/](https://zhangyuchi.gitbooks.io/rocksdbbook/content/Universal-Compaction.html)<br/>  

<ins>Код в TaskDAO.java</ins>
```
public TaskDAO(@NotNull final File data) throws IOException {
            final Options opts = new Options();
            opts.setCreateIfMissing(true) // creates db instance if one does not exist
                .setMaxOpenFiles(-1)  // tunes max number of open files available for DB at the moment
                .setParanoidChecks(false) // drops strict data quality control while searching for corrupt items
                .setSkipStatsUpdateOnDbOpen(true) // abandons statistics updates every time db is opening to run
                .setAllowConcurrentMemtableWrite(true) // permits multithread memtable writes
                .enableWriteThreadAdaptiveYield(); // forces write batch to execute till mutex holding timeout

            opts.disableAutoCompactions(); // prevents from auto compactions as these are enabled by default
            opts.setCompactionStyle(CompactionStyle.UNIVERSAL) // applies universal (tiered) compaction algorithm
                .setCompactionOptionsUniversal(new CompactionOptionsUniversal()
                .setCompressionType(CompressionType.LZ4_COMPRESSION); // involves LZ4 as compression algorithm rather than SNAPPY

            dbLocalDir = data;
            try {
                Files.createDirectories(dbLocalDir.getParentFile().toPath());
                Files.createDirectories(dbLocalDir.getAbsoluteFile().toPath());
                db = RocksDB.open(opts, dbLocalDir.getAbsolutePath());
            } catch (IOException | RocksDBException exc) {
                logger.log(Level.SEVERE, "Storage initialization failed", exc);
            }
        }
```
### 2.1. PUT
<ins>Вывод <em>wrk</em></ins>
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/put.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 81.369ms, rate sampling interval: 629ms
  Thread calibration: mean lat.: 42.386ms, rate sampling interval: 378ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.41ms    8.48ms 195.58ms   98.42%
    Req/Sec     7.51k   127.15     9.60k    96.66%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.34ms
 75.000%    1.93ms
 90.000%    2.65ms
 99.000%   28.98ms
 99.900%  126.91ms
 99.990%  162.82ms
 99.999%  192.00ms
100.000%  195.71ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.073     0.000000            1         1.00
       0.552     0.100000       615076         1.11
       0.776     0.200000      1232597         1.25
       0.969     0.300000      1846106         1.43
       1.155     0.400000      2462421         1.67
       1.342     0.500000      3074714         2.00
       1.442     0.550000      3383007         2.22
       1.548     0.600000      3691114         2.50
       1.662     0.650000      3999187         2.86
       1.787     0.700000      4305947         3.33
       1.929     0.750000      4612224         4.00
       2.009     0.775000      4766984         4.44
       2.097     0.800000      4921152         5.00
       2.197     0.825000      5075966         5.71
       2.313     0.850000      5229015         6.67
       2.457     0.875000      5381312         8.00
       2.545     0.887500      5457682         8.89
       2.653     0.900000      5534727        10.00
       2.791     0.912500      5612181        11.43
       2.977     0.925000      5688329        13.33
       3.273     0.937500      5765359        16.00
       3.515     0.943750      5803611        17.78
       3.899     0.950000      5841968        20.00
       4.523     0.956250      5880320        22.86
       5.387     0.962500      5918822        26.67
       6.359     0.968750      5957236        32.00
       6.867     0.971875      5976548        35.56
       7.439     0.975000      5995641        40.00
       8.163     0.978125      6014901        45.71
       9.239     0.981250      6034099        53.33
      11.031     0.984375      6053283        64.00
      12.503     0.985938      6062882        71.11
      15.415     0.987500      6072501        80.00
      22.927     0.989062      6082096        91.43
      33.375     0.990625      6091705       106.67
      47.295     0.992188      6101314       128.00
      54.815     0.992969      6106120       142.22
      61.983     0.993750      6110922       160.00
      68.927     0.994531      6115764       182.86
      76.799     0.995313      6120544       213.33
      84.607     0.996094      6125358       256.00
      88.703     0.996484      6127771       284.44
      92.543     0.996875      6130139       320.00
      96.959     0.997266      6132552       365.71
     101.951     0.997656      6134958       426.67
     106.687     0.998047      6137349       512.00
     110.463     0.998242      6138554       568.89
     114.943     0.998437      6139758       640.00
     118.847     0.998633      6140961       731.43
     122.751     0.998828      6142148       853.33
     127.487     0.999023      6143360      1024.00
     130.303     0.999121      6143968      1137.78
     132.991     0.999219      6144566      1280.00
     135.423     0.999316      6145155      1462.86
     138.367     0.999414      6145776      1706.67
     141.311     0.999512      6146363      2048.00
     143.359     0.999561      6146656      2275.56
     145.535     0.999609      6146956      2560.00
     147.839     0.999658      6147262      2925.71
     150.143     0.999707      6147560      3413.33
     152.319     0.999756      6147863      4096.00
     153.215     0.999780      6148008      4551.11
     154.879     0.999805      6148169      5120.00
     156.159     0.999829      6148306      5851.43
     157.823     0.999854      6148458      6826.67
     159.871     0.999878      6148604      8192.00
     161.279     0.999890      6148688      9102.22
     163.071     0.999902      6148755     10240.00
     164.607     0.999915      6148832     11702.86
     166.399     0.999927      6148905     13653.33
     168.831     0.999939      6148980     16384.00
     170.239     0.999945      6149019     18204.44
     171.775     0.999951      6149056     20480.00
     173.823     0.999957      6149093     23405.71
     176.639     0.999963      6149130     27306.67
     180.991     0.999969      6149168     32768.00
     183.423     0.999973      6149186     36408.89
     185.983     0.999976      6149204     40960.00
     187.775     0.999979      6149224     46811.43
     188.799     0.999982      6149242     54613.33
     189.823     0.999985      6149263     65536.00
     190.207     0.999986      6149271     72817.78
     190.719     0.999988      6149279     81920.00
     191.871     0.999989      6149290     93622.86
     192.255     0.999991      6149299    109226.67
     192.767     0.999992      6149309    131072.00
     192.895     0.999993      6149315    145635.56
     193.151     0.999994      6149317    163840.00
     193.535     0.999995      6149322    187245.71
     193.791     0.999995      6149327    218453.33
     193.919     0.999996      6149333    262144.00
     193.919     0.999997      6149333    291271.11
     194.175     0.999997      6149336    327680.00
     194.431     0.999997      6149339    374491.43
     194.559     0.999998      6149341    436906.67
     194.687     0.999998      6149344    524288.00
     194.687     0.999998      6149344    582542.22
     194.815     0.999998      6149347    655360.00
     194.815     0.999999      6149347    748982.86
     194.815     0.999999      6149347    873813.33
     195.071     0.999999      6149349   1048576.00
     195.071     0.999999      6149349   1165084.44
     195.199     0.999999      6149350   1310720.00
     195.199     0.999999      6149350   1497965.71
     195.327     0.999999      6149351   1747626.67
     195.455     1.000000      6149353   2097152.00
     195.455     1.000000      6149353   2330168.89
     195.455     1.000000      6149353   2621440.00
     195.455     1.000000      6149353   2995931.43
     195.455     1.000000      6149353   3495253.33
     195.455     1.000000      6149353   4194304.00
     195.455     1.000000      6149353   4660337.78
     195.455     1.000000      6149353   5242880.00
     195.455     1.000000      6149353   5991862.86
     195.711     1.000000      6149354   6990506.67
     195.711     1.000000      6149354          inf
#[Mean    =        2.406, StdDeviation   =        8.479]
#[Max     =      195.584, Total count    =      6149354]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  6299674 requests in 7.00m, 402.53MB read
Requests/sec:  14999.26
Transfer/sec:      0.96MB
```
![put_cpu_ext](https://user-images.githubusercontent.com/55311053/95623828-9791bd80-0a7e-11eb-984b-fd61321ec7f1.jpg)
<p align="center">Рис.5. Выделение процессорного времени при симулировании PUT-запросов (РКХ) </p>

<p float="left">
    <img src="https://user-images.githubusercontent.com/55311053/95623826-96609080-0a7e-11eb-8567-52e2f753fbad.jpg" width="49%" height="100%" />
    <img src="https://user-images.githubusercontent.com/55311053/95623828-9791bd80-0a7e-11eb-984b-fd61321ec7f1.jpg" width="49%" height="100%" />        
</p>   
<p align="center">Рис.6. Сравнение графов событий ЦПУ при выполнении PUT-запросов</p>

![put_alloc_ext](https://user-images.githubusercontent.com/55311053/95623757-7b8e1c00-0a7e-11eb-8e04-d06a5f805681.jpg)
<p align="center">Рис.7. Выделение RAM при симулировании PUT-запросов (РКХ) </p>

<p float="left" width="100%">
    <img src="https://user-images.githubusercontent.com/55311053/95623752-7a5cef00-0a7e-11eb-8566-b2fa09da2d88.jpg" width="49%" height="100%" />
    <img src="https://user-images.githubusercontent.com/55311053/95623757-7b8e1c00-0a7e-11eb-8e04-d06a5f805681.jpg" width="49%" height="100%" />    
</p> 
<p align="center">Рис.8. Сравнение графов аллокаций при выполнении PUT-запросов</p>

При текущей конфигурации БД зафиксировано снижение времени отклика в верхнем диапазоне квантилей (99,9-100%), в то время как результаты измерения 99% случаев указывают на определённое превосходство базового варианта настроек. Можно предположить, что сдерживающим фактором, влияющим на потенциал ускорения сервера, является априори низкая производительность системы, использующей двухъядерный ЦПУ.    

### 2.2. GET
<ins>Вывод <em>wrk</em></ins>
```
max@max-Inspiron-15-3573:~/hackdht$ wrk -t2 -c16 -d7m -s src/profiling/wrk_scripts/get.lua -R15000 --latency http://127.0.0.1:8080
Running 7m test @ http://127.0.0.1:8080
  2 threads and 16 connections
  Thread calibration: mean lat.: 10.730ms, rate sampling interval: 75ms
  Thread calibration: mean lat.: 25.269ms, rate sampling interval: 181ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.56ms    1.26ms  30.03ms   90.42%
    Req/Sec     7.54k   164.07     9.27k    88.29%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.35ms
 75.000%    1.91ms
 90.000%    2.52ms
 99.000%    7.32ms
 99.900%   12.70ms
 99.990%   20.72ms
 99.999%   27.14ms
100.000%   30.05ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.067     0.000000            1         1.00
       0.536     0.100000       615152         1.11
       0.759     0.200000      1230269         1.25
       0.964     0.300000      1846650         1.43
       1.158     0.400000      2462626         1.67
       1.347     0.500000      3077440         2.00
       1.445     0.550000      3385106         2.22
       1.548     0.600000      3690354         2.50
       1.659     0.650000      3999399         2.86
       1.777     0.700000      4306297         3.33
       1.908     0.750000      4613448         4.00
       1.980     0.775000      4766459         4.44
       2.059     0.800000      4920809         5.00
       2.147     0.825000      5073956         5.71
       2.247     0.850000      5227495         6.67
       2.365     0.875000      5381418         8.00
       2.435     0.887500      5457756         8.89
       2.517     0.900000      5534543        10.00
       2.615     0.912500      5611430        11.43
       2.737     0.925000      5688652        13.33
       2.903     0.937500      5765123        16.00
       3.013     0.943750      5803583        17.78
       3.153     0.950000      5842400        20.00
       3.333     0.956250      5880387        22.86
       3.599     0.962500      5918869        26.67
       4.019     0.968750      5957271        32.00
       4.331     0.971875      5976484        35.56
       4.727     0.975000      5995808        40.00
       5.203     0.978125      6014999        45.71
       5.723     0.981250      6034186        53.33
       6.259     0.984375      6053320        64.00
       6.539     0.985938      6063015        71.11
       6.819     0.987500      6072579        80.00
       7.119     0.989062      6082191        91.43
       7.451     0.990625      6091746       106.67
       7.835     0.992188      6101407       128.00
       8.051     0.992969      6106194       142.22
       8.295     0.993750      6110956       160.00
       8.583     0.994531      6115777       182.86
       8.911     0.995313      6120558       213.33
       9.327     0.996094      6125406       256.00
       9.567     0.996484      6127749       284.44
       9.855     0.996875      6130165       320.00
      10.183     0.997266      6132565       365.71
      10.583     0.997656      6134969       426.67
      11.047     0.998047      6137372       512.00
      11.311     0.998242      6138576       568.89
      11.607     0.998437      6139763       640.00
      11.935     0.998633      6140977       731.43
      12.311     0.998828      6142176       853.33
      12.759     0.999023      6143359      1024.00
      13.031     0.999121      6143975      1137.78
      13.327     0.999219      6144573      1280.00
      13.663     0.999316      6145172      1462.86
      14.071     0.999414      6145767      1706.67
      14.567     0.999512      6146364      2048.00
      14.895     0.999561      6146664      2275.56
      15.247     0.999609      6146963      2560.00
      15.759     0.999658      6147264      2925.71
      16.327     0.999707      6147567      3413.33
      17.071     0.999756      6147864      4096.00
      17.487     0.999780      6148016      4551.11
      17.935     0.999805      6148166      5120.00
      18.543     0.999829      6148316      5851.43
      19.119     0.999854      6148469      6826.67
      19.855     0.999878      6148616      8192.00
      20.303     0.999890      6148689      9102.22
      20.815     0.999902      6148765     10240.00
      21.375     0.999915      6148840     11702.86
      22.095     0.999927      6148918     13653.33
      22.975     0.999939      6148991     16384.00
      23.487     0.999945      6149027     18204.44
      24.175     0.999951      6149065     20480.00
      24.735     0.999957      6149102     23405.71
      25.247     0.999963      6149142     27306.67
      25.615     0.999969      6149178     32768.00
      25.775     0.999973      6149196     36408.89
      25.999     0.999976      6149214     40960.00
      26.175     0.999979      6149233     46811.43
      26.415     0.999982      6149252     54613.33
      26.655     0.999985      6149271     65536.00
      26.783     0.999986      6149280     72817.78
      26.959     0.999988      6149291     81920.00
      27.039     0.999989      6149299     93622.86
      27.247     0.999991      6149308    109226.67
      27.535     0.999992      6149318    131072.00
      27.647     0.999993      6149322    145635.56
      27.823     0.999994      6149328    163840.00
      27.935     0.999995      6149332    187245.71
      28.175     0.999995      6149336    218453.33
      28.383     0.999996      6149341    262144.00
      28.463     0.999997      6149344    291271.11
      28.559     0.999997      6149346    327680.00
      28.655     0.999997      6149348    374491.43
      28.687     0.999998      6149350    436906.67
      28.895     0.999998      6149355    524288.00
      28.895     0.999998      6149355    582542.22
      28.895     0.999998      6149355    655360.00
      29.263     0.999999      6149356    748982.86
      29.359     0.999999      6149357    873813.33
      29.407     0.999999      6149359   1048576.00
      29.407     0.999999      6149359   1165084.44
      29.535     0.999999      6149361   1310720.00
      29.535     0.999999      6149361   1497965.71
      29.535     0.999999      6149361   1747626.67
      29.903     1.000000      6149362   2097152.00
      29.903     1.000000      6149362   2330168.89
      29.903     1.000000      6149362   2621440.00
      29.903     1.000000      6149362   2995931.43
      29.999     1.000000      6149363   3495253.33
      29.999     1.000000      6149363   4194304.00
      29.999     1.000000      6149363   4660337.78
      29.999     1.000000      6149363   5242880.00
      29.999     1.000000      6149363   5991862.86
      30.047     1.000000      6149364   6990506.67
      30.047     1.000000      6149364          inf
#[Mean    =        1.564, StdDeviation   =        1.262]
#[Max     =       30.032, Total count    =      6149364]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  6299677 requests in 7.00m, 412.42MB read
  Non-2xx or 3xx responses: 2
Requests/sec:  14998.24
Transfer/sec:      0.98MB
```
![get_cpu_ext](https://user-images.githubusercontent.com/55311053/95623668-60231100-0a7e-11eb-97c3-76c8c4280630.jpg)
<p align="center">Рис.9. Выделение процессорного времени при симулировании GET-запросов (РКХ) </p>

<p float="left" width="100%">
    <img src="https://user-images.githubusercontent.com/55311053/95623646-57323f80-0a7e-11eb-800c-3121d9d5e4d5.jpg" width="49%" height="100%" />
    <img src="https://user-images.githubusercontent.com/55311053/95623668-60231100-0a7e-11eb-97c3-76c8c4280630.jpg" width="49%" height="100%" />    
</p>
<p align="center">Рис.10. Сравнение графов событий ЦПУ при выполнении GET-запросов</p>

![get_alloc_ext](https://user-images.githubusercontent.com/55311053/95623573-2fdb7280-0a7e-11eb-99b8-fad5d51d8f5f.jpg)
<p align="center">Рис.11. Выделение RAM при симулировании GET-запросов (РКХ) </p>

<p float="left" width="100%">
    <img src="https://user-images.githubusercontent.com/55311053/95623570-2eaa4580-0a7e-11eb-9f94-9989463368e5.jpg" width="49%" height="100%" />
    <img src="https://user-images.githubusercontent.com/55311053/95623573-2fdb7280-0a7e-11eb-99b8-fad5d51d8f5f.jpg" width="49%" height="100%" />    
</p>
<p align="center">Рис.12. Сравнение графов аллокаций при выполнении GET-запросов</p>

Единственным заметным отличием текущей статистики следует назвать сокращение времени отклика начиная с 99,99%-го квантиля (на 10-18 мс относительно эквивалентных уровней мониторинга базовой конфигурации). Как и при анализе итогов предыдущей серии, требуется учитывать вероятность аппаратных ограничений, нивелирующих потенциал оптимизации и определяющих достаточную условность отмеченных изменений.  
